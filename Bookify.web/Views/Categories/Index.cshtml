@model IEnumerable<Category>
@{
    ViewData["Title"] = "Categories";
    ViewData["Description"] = "We should list and mange all categories here!";
}

<div class="row gx-6 gx-xl-9">
    <div class="col-lg-12 ">
        @if(!Model.Any()) 
        {
        <!--begin::Card-->
        <div
            class="alert alert-dismissible bg-light-warning border border-warning border-dashed d-flex flex-column flex-sm-row w-100 p-5 mb-10">
            <!--begin::Icon-->
            <i class="ki-duotone ki-information-2 fs-2hx text-warning me-4 mb-5 mb-sm-0"><span
                    class="path1"></span><span class="path2"></span><span class="path3"></span></i> 
            <!--end::Icon-->

            <!--begin::Content-->
            <div class="d-flex flex-column pe-0 pe-sm-10">
                <h5 class="mb-1">No any categories found !</h5>
                <span>The alert component can be used to highlight certain parts of your page for higher content
                    visibility.</span>
            </div>
            <!--end::Content-->

        </div>
        <!--end::Card-->
        } else {
            <div class="table-responsive">
                <table class="table table-hover table-rounded table-striped border gy-7 gs-7">
                    <thead>
                        <tr class="fw-semibold fs-6 text-gray-800 border-bottom-2 border-gray-200">
                            <th>#</th>
                            <th>Name</th>
                            <th>Created On</th>
                            <th>Last Update On</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var category in Model)
                        {
                            <partial name="~/Views/Categories/Modal/_CategoryRow.cshtml" model="@category" />
                        }
                    </tbody>
                </table>
            </div>
        }
       
    </div>
</div>

@section toolbar_buttons {
    <button type="button" class="btn btn-bg-light btn-outline btn-outline-dashed hover-scale" 
            data-bs-toggle="modal" 
            data-bs-target="#categoryModal"
            onclick="onClickNewOrUpdateCategory('Create', $(this))"
            >
        New Category
    </button>
}

@section Scripts {
    <partial name="Modal/_modal" />
    <partial name="_ValidationScriptsPartial" />
    <script>
        function onClickToggleStatusBtn(item) {
            Swal.fire({
                html: `<h1>Are you Sure?</h1>`,
                icon: "info",
                buttonsStyling: false,
                showCancelButton: true,
                confirmButtonText: "Ok, got it!",
                cancelButtonText: 'Nope, cancel it',
                customClass: {
                    confirmButton: "btn btn-primary",
                    cancelButton: 'btn btn-danger'
                }
            }).then((result) => {
                /* Read more about isConfirmed, isDenied below */
                if (result.isConfirmed) {
                    changeToggleStatus(item);
                    Swal.fire("Saved!", "", "success");
                } 
            });
        }
        function changeToggleStatus(item) {
            var id = item.data('id');
            $.ajax({
                method: 'post',
                url: "/Categories/ToggleStatus/"+id, 
                data: {
                    "__RequestVerificationToken": $('meta[name=__RequestVerificationToken]').attr("content"),
                },
                success: function(result){
                    if(result.isDeleted) {
                        var html = (`<span class="badge badge-light-danger fs-base p-3">
                            <i class="ki-outline ki-trash fs-5 text-danger ms-n1 me-3"></i>
                            Deleted
                        </span>`)
                    } else {
                         var html = (`<span class="badge badge-light-success fs-base p-3">
                            <i class="ki-outline ki-subtitle fs-5 text-success ms-n1 me-3"></i>
                            Not Deleted
                        </span>`)
                    }
                    item.parent().parent().find("#isDeleted").html(html)
                    item.parent().parent().find("#updatedOn").text(result.updatedOn)
                }
            });
        }
        var createModal = new bootstrap.Modal(document.getElementById('categoryModal'), {keyboard: false});
        var updateRow;
        function onClickNewOrUpdateCategory(type, button, id = null) {
            $.ajax({
                url: "/Categories/" +(type == 'Update' ? "UpdateAjax" : "CreateAjax") + (id != null ? "/"+id : ""),
                success: function(form){
                    $("#categoryModal").find('.modal-content').html(form);
                    $.validator.unobtrusive.parse($("#categoryModal"))
                },
            });
            if (type == 'Update') updateRow = $('tbody').find("tr#"+id);
        }
        function onSuccessForm(html) {
            showToast('Category added successfully!', 'text-white bg-success');
            createModal.hide()
            $('tbody').append(html)
        }
        function onSuccessEditForm(html) {
            showToast('Category edited successfully!', 'text-white bg-success');
            createModal.hide()
            if(updateRow !== undefined) {
                $(updateRow).replaceWith(html);
                updateRow = undefined;
            }
        }
    </script>
}